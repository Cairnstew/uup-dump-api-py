# Makefile for UUP Dump API testing (using uv)

.PHONY: help install test test-verbose test-coverage test-fast lint format security clean all

# Default target
help:
	@echo "UUP Dump API Test Makefile (uv)"
	@echo ""
	@echo "Available targets:"
	@echo "  make install        - Install all dependencies with uv"
	@echo "  make sync           - Sync dependencies from uv.lock"
	@echo "  make test          - Run all tests"
	@echo "  make test-verbose  - Run tests with verbose output"
	@echo "  make test-coverage - Run tests with coverage report"
	@echo "  make test-fast     - Run tests in parallel (faster)"
	@echo "  make lint          - Run code linters"
	@echo "  make format        - Format code with black and ruff"
	@echo "  make format-check  - Check formatting without changes"
	@echo "  make security      - Run security scans"
	@echo "  make validate      - Validate test setup"
	@echo "  make clean         - Clean generated files"
	@echo "  make all           - Run all checks (test + lint + security)"
	@echo "  make lock          - Update uv.lock file"

# Install uv if not already installed
install-uv:
	@command -v uv >/dev/null 2>&1 || { \
		echo "Installing uv..."; \
		curl -LsSf https://astral.sh/uv/install.sh | sh; \
	}

# Sync dependencies from lock file
sync: install-uv
	uv sync --all-extras

# Install dependencies
install: install-uv
	uv sync --all-extras

# Update lock file
lock: install-uv
	uv lock

# Run basic tests
test:
	uv run pytest test_uup_dump_api.py

# Run tests with verbose output
test-verbose:
	uv run pytest test_uup_dump_api.py -v

# Run tests with coverage
test-coverage:
	uv run pytest test_uup_dump_api.py --cov=. --cov-report=html --cov-report=term-missing

# Run tests in parallel (requires pytest-xdist)
test-fast:
	uv run pytest test_uup_dump_api.py -n auto

# Run specific test class
test-exceptions:
	uv run pytest test_uup_dump_api.py::TestExceptions -v

test-adapter:
	uv run pytest test_uup_dump_api.py::TestRestAdapterMethods -v

test-errors:
	uv run pytest test_uup_dump_api.py::TestRestAdapterGetMethod -v

# Run linters
lint:
	@echo "Running ruff check..."
	-uv run ruff check .
	@echo ""
	@echo "Running ruff format check..."
	-uv run ruff format --check .
	@echo ""
	@echo "Running mypy..."
	-uv run mypy *.py --ignore-missing-imports

# Format code
format:
	@echo "Formatting with ruff..."
	uv run ruff format .
	@echo ""
	@echo "Auto-fixing with ruff..."
	uv run ruff check --fix .
	@echo ""
	@echo "Formatting with black..."
	uv run black .

# Check formatting without modifying files
format-check:
	@echo "Checking formatting..."
	uv run black --check --diff .
	uv run ruff format --check .

# Run security scans
security:
	@echo "Running bandit security scan..."
	-uv run bandit -r . -f screen
	@echo ""
	@echo "Running safety check..."
	-uv run safety check

# Validate test setup
validate:
	uv run python validate_test_setup.py

# Clean generated files
clean:
	rm -rf __pycache__
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage
	rm -rf *.pyc
	rm -rf .mypy_cache
	rm -rf bandit-report.json
	rm -rf .ruff_cache
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

# Run all checks
all: test-coverage lint security
	@echo ""
	@echo "All checks completed!"

# Continuous integration simulation
ci: clean sync all
	@echo ""
	@echo "CI simulation completed!"

# Quick pre-commit checks
pre-commit: format-check test-fast
	@echo ""
	@echo "Pre-commit checks passed!"

# Add a new dependency
add:
	@echo "Usage: make add-dep PKG=package-name"
	@echo "Example: make add-dep PKG=pytest"

add-dep:
	uv add $(PKG)

# Add a dev dependency
add-dev:
	uv add --dev $(PKG)

# Show outdated packages
outdated:
	uv pip list --outdated

# Show installed packages
list:
	uv pip list
